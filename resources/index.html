<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Video Classification Tool</title>
    <link rel="icon" type="image/svg+xml" href="/icons/appIcon.png">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3/dist/vuetify.min.css" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet">
</head>

<body>
    <div id="app">
        <v-app>
            <v-dialog v-model="isLabelEditorOpen" max-width="500px">
                <v-card>
                    <v-card-title>Edit Dataset Labels</v-card-title>
                    <v-card-text>
                        <v-text-field v-for="(label, index) in datasetLabels" :key="index"
                            v-model="datasetLabels[index]" class="mb-2" density="compact" variant="solo">
                            <template v-slot:append>
                                <v-btn icon="mdi-delete" color="red" @click="removeLabel(index)"
                                    :disabled="datasetLabels.length <= 1" title="Remove Label"></v-btn>
                            </template>
                        </v-text-field>
                        <v-btn color="primary" @click="addNewLabel">Add Label</v-btn>
                    </v-card-text>
                    <v-card-actions>
                        <v-spacer></v-spacer>
                        <v-btn text @click="isLabelEditorOpen = false">Close</v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <v-app-bar color="primary" density="comfortable">
                <v-app-bar-title>ML Video Classification Tool</v-app-bar-title>
                <template v-slot:append>
                    <span v-if="stats">
                        Videos: {{ stats.videoCount }} | Images: {{ stats.imageCount }} | Selected: {{ stats.selectedImages }}
                    </span>
                </template>
            </v-app-bar>

            <!-- Left Column: Video Selection -->
            <v-navigation-drawer width="350">
                <v-container class="d-flex flex-column h-100 pa-2">
                    <v-card class="flex-0-0 mb-2">
                        <v-card-text>
                            <!-- Video Folder Selection -->
                            <v-text-field
                                label="Choose Video Folder"
                                :model-value="selectedVideoFolder"
                                :title="selectedVideoFolder"
                                append-inner-icon="mdi-folder-open"
                                @click:append-inner="selectVideoFolder"
                                variant="outlined"
                                readonly
                            ></v-text-field>

                            <v-text-field
                                label="Choose Output Folder"
                                :model-value="outputFolder"
                                :title="outputFolder"
                                append-inner-icon="mdi-folder-open"
                                @click:append-inner="selectOutputFolder"
                                variant="outlined"
                                readonly
                            ></v-text-field>
                        </v-card-text>
                    </v-card>

                    <!-- Video List -->
                    <v-card class="flex-1-1 overflow-auto mb-2">
                        <v-toolbar density="compact">
                            <v-toolbar-title>Select Videos</v-toolbar-title>
                            <v-btn icon="mdi-filter-check-outline" title="show processed"
                                @click="hideProcessedVideos = !hideProcessedVideos"
                                :class="{ 'opacity-30': hideProcessedVideos }"></v-btn>
                        </v-toolbar>
                        <v-list density="compact">
                            <v-list-item v-for="video in filteredVideoFiles" 
                                :key="video" 
                                :value="video"
                                :title="video" 
                                @click="selectVideo(video)" 
                                :class="{ 'v-item--active': currentVideo === video,
                                                'processed': processedVideoFiles.has(video) }"
                                class="video-list-item">
                                <template v-slot:prepend="{ isSelected, select }">
                                    <v-list-item-action start>
                                        <v-checkbox-btn 
                                            :model-value="selectedVideoFiles.includes(video)"
                                            @update:model-value="toggleSelectedVideo(video)"
                                            @click.stop></v-checkbox-btn>
                                    </v-list-item-action>
                                </template>
                            </v-list-item>
                        </v-list>
                    </v-card>

                    <!-- frame processing controls -->
                    <v-card class="flex-0-0">
                        <v-card-text>
                            <v-number-input
                                label="frame rate"
                                control-variant="stacked"
                                variant="outlined"
                                v-model="imageExtractionFramerate"
                                :min="0"
                                :max="100"
                                :precision="1"
                                ></v-number-input>
                            <v-btn color="success"
                                block
                                :disabled="!selectedVideoFolder || !outputFolder || videoFiles.length === 0"
                                :loading="isPreprocessing"
                                @click="extractFramesFromVideos"
                                prepend-icon="mdi-play"
                                title="Extract images from selected videos at the configured frame rate">
                                Extract Images
                            </v-btn>
                        </v-card-text>
                    </v-card>
                </v-container>
            </v-navigation-drawer>

            <v-main>
                <!-- Center Column: Video proview / Image Gallery -->
                <v-container class="d-flex flex-column pa-2">
                    <!-- Video Player -->
                    <v-card v-if="currentVideo" class="d-flex flex-column">
                        <v-toolbar density="compact">
                            <v-toolbar-title>Video Preview</v-toolbar-title>
                            <v-btn icon="mdi-close" @click="currentVideo = null" title="Close Preview"></v-btn>
                        </v-toolbar>
                        <v-card-text class="d-flex justify-center ma-4">
                            <video :src="currentVideoUrl" width="80%" controls
                                style="background: #000; border-radius: 4px;">
                            </video>
                        </v-card-text>
                    </v-card>

                    <!-- Image Gallery -->
                    <v-card v-else>
                        <v-toolbar density="compact">
                            <v-toolbar-title>Images to Classify</v-toolbar-title>
                            <v-slider v-model="previewSize" label="Image Size" min="128" max="512" step="16"
                                style="max-width: 250px" class="align-center" hide-details>
                                <template v-slot:append>
                                    <span v-text="previewSize + 'px'"></span>
                                </template>
                            </v-slider>
                            <v-btn icon="mdi-reload" @click="loadImageFiles" title="Reload Images"></v-btn>
                        </v-toolbar>
                        <v-card-text>
                            <div v-if="imageFiles.length === 0" class="flex-center">
                                <p class="text-caption text-disabled">No images to process</p>
                            </div>
                            <div v-else style="flex: 1; overflow-y: auto;">
                                <div ref="imageGallery" class="image-gallery"
                                    :style="{ '--preview-size': previewSize + 'px' }">
                                    <div v-for="image in imageFiles" :key="image" class="gallery-item"
                                        :class="{ 'selected': selectedImages.includes(image) }"
                                        @click="handleImageSelect(image, $event)"
                                        @contextmenu.prevent="handleImageSelect(image, { ctrlKey: true, shiftKey: false })"
                                        draggable="true">
                                        <img :src="getImageUrl(image)" :alt="image" :width="previewSize"
                                            :height="previewSize">
                                        <div class="image-name">{{ image }}</div>
                                    </div>
                                </div>
                            </div>
                        </v-card-text>
                    </v-card>
                </v-container>
            </v-main>

            <!-- Right Column: Label Assignment -->
            <v-navigation-drawer location="right" width="300">
                <v-container class="d-flex flex-column h-100 pa-2">
                    <v-card>
                        <v-toolbar density="compact">
                            <v-toolbar-title>Assign Label</v-toolbar-title>
                            <v-btn icon="mdi-playlist-edit" @click="isLabelEditorOpen = true"
                                title="Edit Labels"></v-btn>
                        </v-toolbar>
                        <v-card-text v-if="datasetLabels.length > 0">
                            <!-- Label Buttons -->
                            <v-btn v-for="(label, index) in datasetLabels" :key="index" 
                                block
                                color="info"
                                :disabled="selectedImages.length === 0" 
                                @click="assignLabel(index)"
                                :text="label"
                                class="mb-2"
                            >
                                <template v-slot:append>
                                    <v-hotkey variant="plain" :keys="getKeyboardShortcut(index)"></v-hotkey>
                                </template>
                            </v-btn>
                        </v-card-text>

                        <v-card-text v-else class="flex-center mt-4">
                            <p class="text-caption text-disabled">Select output folder</p>
                        </v-card-text>
                    </v-card>

                    <v-card class="mt-2">
                        <v-toolbar density="compact">
                            <v-toolbar-title>Statistics</v-toolbar-title>
                            <v-btn icon="mdi-refresh" @click="updateLabelStatistics" title="Refresh Statistics"></v-btn>
                        </v-toolbar>
                        <v-card-text>
                            <v-list density="compact">
                                <v-list-item v-for="(label, index) in datasetLabels" :key="index">
                                    <v-list-item-title>
                                        {{ datasetLabels[index] }}: {{ labelStatistics[label] || 0 }}
                                    </v-list-item-title>
                                </v-list-item>
                            </v-list>
                        </v-card-text>
                    </v-card>

                    <v-card class="mt-2">
                        <v-toolbar density="compact">
                            <v-toolbar-title>Create Training Dataset</v-toolbar-title>
                        </v-toolbar>
                        <v-card-text>
                            <div class="text-caption">Training Set Percentage</div>
                            <v-slider v-model="trainingSplit"
                                min="0.5"
                                max="0.95"
                                step="0.01"
                                class="mb-4"
                                hide-details>
                                <template v-slot:append>
                                    <span v-text="Math.floor(trainingSplit * 100) + '%'"></span>
                                </template>
                            </v-slider>
                            <v-btn color="success"
                                block
                                @click="createTrainingDataset"
                                prepend-icon="mdi-folder-plus"
                                title="Create Training Dataset">
                                Create Training Dataset
                            </v-btn>
                        </v-card-text>
                </v-container>
            </v-navigation-drawer>

            <!-- Snackbar for notifications -->
            <v-snackbar v-model="snackbar.visible" :timeout="snackbar.timeout" :color="snackbar.color">
                {{ snackbar.message }}
            </v-snackbar>
        </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3/dist/vuetify.min.js"></script>
    <script src="/js/neutralino.js"></script>
    <script src="/js/app.js"></script>
</body>

</html>